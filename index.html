<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="index.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/icon.ico" type="image/x-icon" />
    <title>Space Invaders</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <div class="menu">
        <h1 class="title">SPACE INVADERS</h1>
        <button class="play-button" id="playButton">Play</button>
        <div class="volume-container">
            <span class="volume-label">Music Volume</span>
            <input type="range" class="volume-slider" id="volumeControl" min="0" max="100" value="50">
        </div>
    </div>

    <div class="game-container" id="gameContainer">
        <canvas id="gameCanvas"></canvas>
    </div>

    <audio id="backgroundMusic">
        <source src="sounds/SpaceInvaders.mp3" type="audio/mpeg">
    </audio>

    <!-- Load Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        let music = document.getElementById("backgroundMusic");
        let volumeSlider = document.getElementById("volumeControl");

        function startMusic() {
            music.volume = volumeSlider.value / 100;
            music.play().catch(error => console.error("Music playback blocked:", error));
        }

        document.addEventListener("click", startMusic, { once: true });
        document.addEventListener("keydown", startMusic, { once: true });

        volumeSlider.addEventListener("input", (event) => {
            music.volume = event.target.value / 100;
        });

        music.loop = true;
        music.addEventListener("ended", function () {
            console.warn("Music ended unexpectedly. Restarting...");
            music.currentTime = 0;
            music.play();
        });

        document.getElementById("playButton").addEventListener("click", () => {
            console.log("Play button clicked!");

            document.querySelector(".menu").style.display = "none";
            document.getElementById("gameContainer").style.display = "block";
            document.body.classList.add("game-started");

            volumeSlider.disabled = true;

            startGame();
        });
    </script>

    <!-- ========================== GAME LOGIC ========================== -->
    <script>
        // ========================== GLOBAL VARIABLES ==========================
        let scene, camera, renderer;
        let ship, aliens = [];
        let isPOVMode = false; // Track current mode
        let overlayCanvas, overlayContext; // 2D replica for POV mode

        function initGame() {
            // ========================== SCENE SETUP ==========================
            scene = new THREE.Scene();

            // Create renderer
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("gameCanvas") });
            if (isPOVMode) {
                renderer.setSize(window.innerWidth * 0.75, window.innerHeight); // 75% of screen width, full height
            } else {
                renderer.setSize(400, 400); // Arcade mode remains small
            }

            // ========================== CAMERA SETUP ==========================
            setupCameras();

            // ========================== OBJECT CREATION ==========================
            createShip();
            createAliens();

            // ========================== UI SETUP ==========================
            setupOverlay();

            // ========================== EVENT LISTENERS ==========================
            document.addEventListener("keydown", switchGameMode);
        }

        function switchGameMode(event) {
            // ========================== GAME MODE SWITCH (G KEY) ==========================
            if (event.key.toLowerCase() === "g") { // Detect "G" key
                event.preventDefault();
                isPOVMode = !isPOVMode;

                if (isPOVMode) {
                    camera = povCamera;
                    overlayCanvas.style.display = "block"; // Show 2D game replica
                    console.log("Switched to POV Mode");
                } else {
                    camera = arcadeCamera;
                    overlayCanvas.style.display = "none"; // Hide 2D game replica
                    console.log("Switched to Arcade Mode");
                }   
            }
        }

        function setupCameras() {
            // ========================== POV MODE (First Person) ==========================
            povCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            povCamera.position.set(0, 1, 0); // Adjust based on ship size

            // ========================== ARCADE MODE (Third Person) ==========================
            arcadeCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            arcadeCamera.position.set(0, 5, 10);
            arcadeCamera.lookAt(0, 0, 0);

            // Set default camera to Arcade Mode
            camera = arcadeCamera;
        }

        function createShip() {
            // ========================== PLAYER SHIP ==========================
            const geometry = new THREE.BoxGeometry(1, 1, 2); // Placeholder shape
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            ship = new THREE.Mesh(geometry, material);
            ship.position.set(0, 0, 0);
            scene.add(ship);
        }

        function createAliens() {
            // ========================== ENEMY ALIENS ==========================
            const alienGeometry = new THREE.SphereGeometry(0.5, 16, 16);
            const alienMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });

            for (let i = 0; i < 5; i++) {
                let alien = new THREE.Mesh(alienGeometry, alienMaterial);
                alien.position.set(i * 2 - 4, 2, -5); // Spread out in front
                scene.add(alien);
                aliens.push(alien);
            }
        }

        function setupOverlay() {
            // ========================== 2D GAME REPLICA (POV MODE) ==========================
            overlayCanvas = document.createElement("canvas");
            overlayCanvas.style.position = "absolute";
            overlayCanvas.style.top = "10px";
            overlayCanvas.style.right = "10px"; // Align to the right
            overlayCanvas.style.width = "20vw"; // 20% of the screen width
            overlayCanvas.style.height = "30vh"; // 30% of the screen height
            overlayCanvas.style.border = "2px solid white";
            overlayCanvas.style.display = "none"; // Hidden by default

            overlayContext = overlayCanvas.getContext("2d");
            document.body.appendChild(overlayCanvas);
        }

        function animate() {
            // ========================== RENDER LOOP ==========================
            requestAnimationFrame(animate);
            renderer.render(scene, camera);

            // ========================== DRAW OVERLAY (POV MODE) ==========================
            if (isPOVMode) {
                drawOverlay();
            }
        }

        function drawOverlay() {
            overlayContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            overlayContext.fillStyle = "white";
            overlayContext.fillText("2D Game Replica (Placeholder)", 10, 20);
        }

        function startGame() {
            // ========================== GAME START ==========================
            if (!scene) {
                initGame(); // Initialize the game once
            }
            animate(); // Start the game animation
        }
    </script>

</body>
</html>
